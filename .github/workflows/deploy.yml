name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/ubuntu/psychology-website

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, gd
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: |
          export APP_ENV=prod
          composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist --no-scripts

      - name: Install Yarn dependencies
        run: yarn install --frozen-lockfile

      - name: Build frontend assets
        run: yarn build

      - name: Create production .env file
        run: |
          echo "APP_ENV=prod" > .env.local
          echo "APP_SECRET=${{ secrets.APP_SECRET }}" >> .env.local
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.local
          echo "JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem" >> .env.local
          echo "JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem" >> .env.local
          echo "JWT_PASSPHRASE=${{ secrets.JWT_PASSPHRASE }}" >> .env.local
          echo "CORS_ALLOW_ORIGIN='^https?://(psychology\.elydris\.fr|localhost)(:[0-9]+)?$'" >> .env.local
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env.local
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env.local
          echo "GOOGLE_REDIRECT_URI=https://psychology.elydris.fr/connect/google/check" >> .env.local

      - name: Create JWT keys from secrets
        run: |
          mkdir -p config/jwt
          echo "${{ secrets.JWT_PRIVATE_KEY }}" > config/jwt/private.pem
          echo "${{ secrets.JWT_PUBLIC_KEY }}" > config/jwt/public.pem
          chmod 644 config/jwt/private.pem
          chmod 644 config/jwt/public.pem

      - name: Deploy via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "bin,config,migrations,public,src,templates,vendor,composer.json,symfony.lock,compose.yaml,.env,.env.local"
          target: ${{ env.DEPLOY_PATH }}
          overwrite: true

      - name: Execute post-deployment commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd ${{ env.DEPLOY_PATH }}

            # Créer les dossiers nécessaires
            mkdir -p var/cache var/log

            # Permissions
            chmod -R 775 var/
            chmod 600 config/jwt/private.pem
            chmod 644 config/jwt/public.pem

            # Créer le fichier .env pour Docker avec le mot de passe DB
            echo "MYSQL_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env.docker
            echo "MYSQL_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env.docker

            # Démarrer/Redémarrer la base de données MariaDB
            docker compose --env-file .env.docker up -d

            # Attendre que MariaDB soit prêt
            echo "Waiting for database..."
            sleep 20

            # Exécuter les migrations
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod

            # Vider et réchauffer le cache
            php bin/console cache:clear --env=prod --no-debug
            php bin/console cache:warmup --env=prod

            # Créer le service systemd pour PHP si nécessaire
            sudo tee /etc/systemd/system/psychology-php.service > /dev/null << 'SYSTEMD'
            [Unit]
            Description=Psychology Website PHP Server
            After=network.target docker.service

            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=/home/ubuntu/psychology-website
            ExecStart=/usr/bin/php -S 0.0.0.0:8002 -t public
            Restart=always
            RestartSec=5
            StandardOutput=append:/home/ubuntu/psychology-website/var/log/php-server.log
            StandardError=append:/home/ubuntu/psychology-website/var/log/php-server.log

            [Install]
            WantedBy=multi-user.target
            SYSTEMD

            # Recharger systemd et redémarrer le service
            sudo systemctl daemon-reload
            sudo systemctl enable psychology-php
            sudo systemctl restart psychology-php

            # Vérifier que le serveur a démarré
            sleep 2
            if systemctl is-active --quiet psychology-php; then
              echo "Deployment completed successfully! Server running on port 8002"
            else
              echo "Warning: PHP server may not have started correctly"
              sudo systemctl status psychology-php
            fi

      - name: Deployment notification
        run: echo "✅ Deployment to VPS succeeded!"
